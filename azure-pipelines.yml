trigger:
  branches:
    include:
    - '*'
  tags:
    include:
    - '*'

variables:
  CKBClientVersion: v0.33.1

jobs:
  - job: UnitTest
    pool:
      vmImage: 'windows-2019'
    steps:
      - template: devtools/azure/windows-dependencies.yml
        parameters:
          rustup_toolchain: '1.41.0-x86_64-pc-windows-msvc'
      - powershell: devtools/windows/make test
        displayName: Run unit tests
        env:
          CI: true

  - job: IntegrationTest
    timeoutInMinutes: 0
    pool:
      vmImage: 'windows-2019'
    steps:
      - template: devtools/azure/windows-dependencies.yml
        parameters:
          rustup_toolchain: '1.41.0-x86_64-pc-windows-msvc'
      - powershell: devtools/windows/make CKB_TEST_SEC_COEFFICIENT=5 CKB_TEST_ARGS="--max-time 1200 -c 4" integration
        displayName: Run integration tests
        env:
          CI: true

  - job: Package
    timeoutInMinutes: 0
    pool:
      vmImage: 'windows-2019'
    steps:
      - template: devtools/azure/windows-dependencies.yml
        parameters:
          rustup_toolchain: '1.41.0-x86_64-pc-windows-msvc'
      - powershell: devtools/windows/make prod
        displayName: Build
